<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YRYS - Zone Presence Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/index.css?v=1">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <svg class="logo" viewBox="0 0 1609.48 1543.54" xmlns="http://www.w3.org/2000/svg">
                    <polygon fill="#0b58d8" points="1609.48 1410.4 708.85 1543.42 856.3 1002.13 1148.84 958.84 1148.96 958.87 1609.48 1410.4"/>
                    <polygon fill="#10b0f9" points="856.3 1002.13 708.81 1543.54 708.69 1543.51 0 971.95 625.87 816.5 625.99 816.53 856.18 1002.1 856.3 1002.13"/>
                    <polygon fill="#f93b09" points="1440.85 915.14 998.21 481.22 1129.3 0 1440.85 915.14"/>
                    <polygon fill="#bd44d5" points="1609.48 1410.4 1148.96 958.87 1441.08 915.72 1609.48 1410.4"/>
                    <polygon fill="#fc5607" points="1129.3 0 998.21 481.22 998.12 481.07 396.67 630.56 1129.3 0"/>
                    <polygon fill="#e7ab37" points="625.87 816.5 0 971.95 396.03 631.03 625.87 816.5"/>
                    <polygon fill="#f8d239" points="998.21 481.22 927.27 741.62 625.99 816.53 625.87 816.5 396.03 631.03 396.67 630.56 998.12 481.07 998.21 481.22"/>
                    <polygon fill="#f08321" points="1441.08 915.72 1148.96 958.87 1148.84 958.84 927.27 741.62 998.21 481.22 1440.85 915.14 1441.08 915.72"/>
                    <polygon fill="#062db6" points="1148.84 958.84 856.3 1002.13 927.27 741.62 1148.84 958.84"/>
                    <polygon fill="#7475d8" points="927.27 741.62 856.3 1002.13 856.18 1002.1 625.99 816.53 927.27 741.62"/>
                </svg>
                <span class="logo-text">YRYS</span>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">General</div>
                <nav class="sidebar-nav">
                    <a class="nav-item active" id="navSites">
                        <img class="nav-icon-img" src="/static/assets_youn/SvIcons/folder-svgrepo-com.svg" alt="">
                        Sites
                    </a>
                    <a class="nav-item" id="navTracker">
                        <img class="nav-icon-img" src="/static/assets_youn/SvIcons/desktop-svgrepo-com.svg" alt="">
                        Zone Tracker
                    </a>
                    <a class="nav-item" href="/static/observations.html" target="_blank" rel="noopener">
                        <img class="nav-icon-img" src="/static/assets_youn/SvIcons/bug-svgrepo-com.svg" alt="">
                        Observations
                    </a>
                </nav>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Active Zones</div>
                <div class="zone-list-sidebar" id="zoneListSidebar">
                    <div style="color: var(--color-text-subtle); font-size: var(--text-sm);">Aucune zone</div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="version-badge">©2025 YRYS, Inc — v1.0</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header-bar">
                <div>
                    <h1 class="page-title" id="pageTitle">Zone Presence Tracker</h1>
                    <p class="page-subtitle" id="pageSubtitle">Surveillance et analyse du temps de présence</p>
                </div>
                <div class="header-actions">
                    <div class="steps">
                        <div class="step" id="step1" title="Caméra">
                            <img class="step-icon-img" src="/static/assets_youn/SvIcons/video-camera-svgrepo-com.svg" alt="">
                            <span class="step-num">1</span>
                        </div>
                        <div class="step" id="step2" title="Zones">
                            <img class="step-icon-img" src="/static/assets_youn/SvIcons/includezone.svg" alt="">
                            <span class="step-num">2</span>
                        </div>
                        <div class="step" id="step3" title="Détection">
                            <img class="step-icon-img" src="/static/assets_youn/SvIcons/checkmark-svgrepo-com.svg" alt="">
                            <span class="step-num">3</span>
                        </div>
                    </div>
                    <div class="status-indicator ready" id="statusBadge">
                        <span class="status-dot-indicator"></span>
                        <span id="statusText">Prêt</span>
                    </div>
                </div>
            </header>

            <!-- Home (Sites) -->
            <section class="zones-section" id="homeView">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-subtitle">Multi-site</div>
                            <div class="card-title">Sites</div>
                        </div>
                    </div>
                    <div style="padding: var(--space-4); border-top: 1px solid var(--color-border); display:flex; gap: var(--space-3); align-items:center; flex-wrap:wrap;">
                        <input id="newSiteName" type="text" placeholder="Nom du site (ex: Entrepôt Lyon)" style="flex:1; min-width: 260px; padding: 12px 14px; border-radius: var(--radius-md); border: 1px solid var(--color-border); background: var(--color-surface-2); color: var(--color-text); outline: none;">
                        <button class="btn btn-primary" id="createSiteBtn" type="button">Créer le site</button>
                    </div>
                    <div style="padding: var(--space-4);">
                        <div class="zones-grid" id="sitesGrid" style="grid-template-columns: repeat(3, minmax(0, 1fr));">
                            <div class="no-zones">Aucun site. Créez-en un pour commencer.</div>
                        </div>
                    </div>
                </div>
            </section>

            <div id="trackerView" class="hidden">
            <!-- Hidden elements for legacy compatibility -->
            <div class="hidden">
                <select id="videoSelect">
                    <option value="">-- Choisir une vidéo --</option>
                </select>
                <input type="file" id="videoUpload" accept="video/*">
                <img id="videoFrame" alt="Video frame">
                <img id="videoStream" alt="Video stream">
                <canvas id="drawCanvas"></canvas>
            </div>

            <!-- Dashboard Section -->
            <section class="dashboard-section">
                <!-- Stats Overview -->
                <div class="dashboard-header">
                    <div class="stats-overview card">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value" id="dashCameras">0</span>
                                <span class="stat-label">Cameras</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="dashZones">0</span>
                                <span class="stat-label">Zones</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="dashOccupancy">0%</span>
                                <span class="stat-label">Occupation moy.</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="dashActiveStreams">0</span>
                                <span class="stat-label">Detections actives</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions card">
                        <button class="retro-btn retro-default" id="startDetectionBtn" disabled title="Selectionner une camera">
                            <span class="retro-btn-inner">
                                <img class="retro-icon-img" src="/static/assets_youn/SvIcons/play-svgrepo-com.svg" alt="">
                                Detection
                            </span>
                        </button>
                        <button class="retro-btn retro-darkGray" id="stopAllBtn" disabled>
                            <span class="retro-btn-inner">
                                <img class="retro-icon-img" src="/static/assets_youn/SvIcons/stop-svgrepo-com.svg" alt="">
                                Stop all
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Main Dashboard Grid -->
                <div class="dashboard-grid">
                    <!-- Cameras Panel -->
                    <div class="cameras-panel card">
                        <div class="card-header">
                            <div>
                                <div class="card-subtitle">Configuration</div>
                                <div class="card-title">Cameras</div>
                            </div>
                            <button class="btn btn-secondary btn-icon" id="addCameraBtn" title="Ajouter une camera" type="button">+</button>
                        </div>
                        <div class="hidden" id="addCameraForm" style="padding: var(--space-4); border-top: 1px solid var(--color-border); display:flex; flex-direction:column; gap: var(--space-3);">
                            <!-- Source type tabs -->
                            <div style="display:flex; gap: var(--space-2); border-bottom: 1px solid var(--color-border); padding-bottom: var(--space-2);">
                                <button class="btn btn-secondary cam-source-tab active" data-source="video" type="button">Video</button>
                                <button class="btn btn-secondary cam-source-tab" data-source="webcam" type="button">Webcam</button>
                                <button class="btn btn-secondary cam-source-tab" data-source="rtsp" type="button">RTSP</button>
                            </div>

                            <div style="display:flex; gap: var(--space-3); flex-wrap:wrap;">
                                <div class="form-group" style="flex:1; min-width:200px;">
                                    <label class="form-label">Nom camera</label>
                                    <input id="newCamName" type="text" placeholder="Ex: Entrepot" style="width:100%;">
                                </div>
                                <!-- Video source -->
                                <div class="form-group cam-source-panel" data-source="video" style="flex:1; min-width:200px;">
                                    <label class="form-label">Video</label>
                                    <select id="newCamVideo" class="lov-select" style="width:100%;"></select>
                                </div>
                                <!-- Webcam source -->
                                <div class="form-group cam-source-panel hidden" data-source="webcam" style="flex:1; min-width:200px;">
                                    <label class="form-label">Webcam</label>
                                    <div style="display:flex; gap: var(--space-2);">
                                        <select id="newCamWebcam" class="lov-select" style="flex:1;"></select>
                                        <button class="btn btn-secondary btn-icon" id="detectWebcamsBtn" title="Detecter les webcams" type="button">&#x1F50D;</button>
                                    </div>
                                </div>
                                <!-- RTSP source -->
                                <div class="form-group cam-source-panel hidden" data-source="rtsp" style="flex:1; min-width:200px;">
                                    <label class="form-label">URL RTSP</label>
                                    <div style="display:flex; gap: var(--space-2);">
                                        <input id="newCamRtspUrl" type="text" placeholder="rtsp://192.168.1.10:554/stream" style="flex:1;">
                                        <button class="btn btn-secondary btn-icon" id="testRtspBtn" title="Tester la connexion" type="button">&#x2713;</button>
                                    </div>
                                </div>
                            </div>
                            <!-- Video upload (only for video source) -->
                            <div class="cam-source-panel" data-source="video" style="display:flex; align-items:center; gap: var(--space-3); padding: var(--space-3); background: var(--color-bg-secondary); border-radius: var(--radius-md);">
                                <span style="color: var(--color-text-secondary); font-size: 14px;">Ou uploader une nouvelle video :</span>
                                <form id="uploadVideoForm" style="display:contents;">
                                    <label class="btn btn-secondary" style="cursor:pointer; margin:0;">
                                        <input type="file" id="uploadVideoInput" accept="video/*" style="display:none;">
                                        <span id="uploadVideoLabelText">Choisir un fichier</span>
                                    </label>
                                </form>
                                <span id="uploadProgress" style="color: var(--color-text-secondary); font-size: 13px;"></span>
                            </div>
                            <!-- RTSP scan (only for rtsp source) -->
                            <div class="cam-source-panel hidden" data-source="rtsp" style="display:flex; align-items:center; gap: var(--space-3); padding: var(--space-3); background: var(--color-bg-secondary); border-radius: var(--radius-md);">
                                <span style="color: var(--color-text-secondary); font-size: 14px;">Scanner le reseau local :</span>
                                <button class="btn btn-secondary" id="scanOnvifBtn" type="button">Scan ONVIF</button>
                                <span id="onvifScanStatus" style="color: var(--color-text-secondary); font-size: 13px;"></span>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description (optionnel)</label>
                                <input id="newCamHint" type="text" placeholder="Ex: Dechargement & presence" style="width:100%;">
                            </div>
                            <div style="display:flex; gap: var(--space-3);">
                                <button class="btn btn-primary" id="saveCamBtn" type="button">Ajouter</button>
                                <button class="btn btn-secondary" id="cancelCamBtn" type="button">Annuler</button>
                            </div>
                        </div>
                        <div class="camera-list" id="cameraGrid">
                            <!-- Cameras will be populated here -->
                        </div>
                    </div>

                    <!-- Zones Dashboard -->
                    <div class="zones-dashboard card">
                        <div class="card-header">
                            <div>
                                <div class="card-subtitle">Statistiques</div>
                                <div class="card-title">Zones de detection</div>
                            </div>
                            <button class="btn btn-ghost btn-small" id="deleteAllZonesBtn" title="Reset all">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                Reset
                            </button>
                        </div>
                        <div class="zones-grid" id="zonesGrid">
                            <div class="no-zones">Aucune zone definie. Selectionnez une camera et cliquez sur "Editer zones".</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Legacy hidden elements -->
            <div class="hidden">
                <button id="editZonesBtn"></button>
                <button id="toggleBlurBtn"></button>
                <button id="stopDetectionBtn"></button>
                <div id="placeholder"></div>
                <div id="videoWrapper"></div>
                <div id="videoContainer"></div>
                <div id="drawHud"></div>
                <div id="drawHudTitle"></div>
                <div id="drawInstructions"></div>
                <button id="undoBtn"></button>
                <button id="finishBtn"></button>
                <button id="cancelBtn"></button>
                <button id="drawFab"></button>
                <button id="toggleDrawPanelBtn"></button>
                <div id="drawPanel"></div>
                <select id="drawZoneSelect"></select>
                <div id="drawZoneNameGroup"></div>
                <input id="drawZoneName">
                <button id="toolPolyBtn"></button>
                <button id="toolLineBtn"></button>
                <button id="startDrawBtn"></button>
                <button id="stopDrawBtn"></button>
                <button id="editSelectedBtn"></button>
                <button id="addPointBtn"></button>
                <button id="deletePointBtn"></button>
                <button id="saveEditBtn"></button>
                <div id="activeStreams"></div>
                <span id="currentVideoTitle"></span>
            </div>

            <!-- Legacy recap elements (hidden for backward compat) -->
            <div class="hidden">
                <div id="recapGrid">
                    <div id="recapCameras"></div>
                    <div id="recapCamerasSub"></div>
                    <div id="recapZones"></div>
                    <div id="recapZonesSub"></div>
                    <div id="recapDrawings"></div>
                    <div id="recapDrawingsSub"></div>
                    <div id="recapActive"></div>
                    <div id="recapActiveSub"></div>
                </div>
            </div>
            </div>
        </main>
    </div>

    <!-- Drawing Editor Modal (paint-like) -->
    <div class="editor-overlay hidden" id="editorOverlay" role="dialog" aria-modal="true" aria-label="Éditeur de zones">
        <div class="editor">
            <div class="editor-topbar">
                <div>
                    <div class="editor-title" id="editorTitle">Video Editing</div>
                    <div class="editor-subtitle" id="editorSubtitle">Outils de dessin</div>
                </div>
                <button class="btn btn-ghost btn-icon" id="editorCloseBtn" title="Fermer">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="editor-body">
                <div class="editor-left">
                    <div class="editor-canvas-wrap">
                        <img id="editorFrame" alt="Frame">
                        <canvas id="editorCanvas"></canvas>
                        <div class="editor-hoverbar hidden" id="editorHoverBar">
                            <button class="editor-hoverbtn danger" id="hoverDeletePointBtn" title="Supprimer le point">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 6l12 12M18 6L6 18"/>
                                </svg>
                            </button>
                            <button class="editor-hoverbtn danger" id="hoverDeleteShapeBtn" title="Supprimer la forme">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="editor-tools">
                        <div class="tool-row">
                            <div class="tool-row-left">
                                <button class="tool-btn icon primary active" id="toolSelectBtn" title="Sélection">
                                    <img class="tool-ico" src="/static/assets_youn/YrysUIPackage/selection.svg" alt="">
                                    <span class="tool-label">Sélect</span>
                                </button>
                                <button class="tool-btn icon" id="toolCountLineBtn" title="Ligne de comptage">
                                    <img class="tool-ico" src="/static/assets_youn/YrysUIPackage/comptage.svg" alt="">
                                    <span class="tool-label">Compter</span>
                                </button>
                                <button class="tool-btn icon green" id="toolIncludeBtn" title="Zone d’inclusion">
                                    <img class="tool-ico" src="/static/assets_youn/YrysUIPackage/drawzone.svg" alt="">
                                    <span class="tool-label">Inclure</span>
                                </button>
                                <button class="tool-btn icon yellow" id="toolExcludeBtn" title="Zone d’exclusion">
                                    <img class="tool-ico" src="/static/assets_youn/SvIcons/intersect-svgrepo-com%20(1).svg" alt="">
                                    <span class="tool-label">Exclure</span>
                                </button>
                                <button class="tool-btn icon compact" id="toolUndoBtn" title="Annuler (Ctrl+Z)">↶</button>
                                <button class="tool-btn icon red compact" id="toolClearBtn" title="Tout effacer">✕</button>
                            </div>
                            <button class="tool-btn save" id="toolSaveBtn" title="Sauvegarder toute la configuration">Sauvegarder</button>
                        </div>

                        <div class="editor-guide" id="editorGuide">
                            1) Choisissez une zone à droite. 2) Dessinez (ligne ou polygone). 3) Ajustez les points. 4) Sauvegardez.
                        </div>
                    </div>
                </div>

                <div class="editor-right">
                    <div class="editor-card">
                        <h3>Informations sur la caméra</h3>
                        <div class="editor-kv">
                            <div class="k">ID</div><div id="editorCamId">—</div>
                            <div class="k">Rés.</div><div id="editorCamRes">—</div>
                            <div class="k">Statut</div><div id="editorCamStatus">—</div>
                            <div class="k">Src.</div><div id="editorCamSource">—</div>
                        </div>
                    </div>

                    <div class="editor-card">
                        <h3>Associated Zones</h3>
                        <div class="editor-zones" id="editorZoneList"></div>
                        <div style="margin-top: 10px; display:flex; gap:8px;">
                            <input type="text" id="editorNewZoneName" placeholder="Nouvelle zone…" style="flex:1; min-width:0; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); color:#F5F7FF;">
                            <button class="tool-btn primary" id="editorAddZoneBtn">+</button>
                        </div>
                        <div style="margin-top: 10px; display:flex; justify-content:flex-end;">
                            <button class="tool-btn red" id="editorDeleteZoneBtn" title="Supprimer la zone sélectionnée">Supprimer la zone</button>
                        </div>
                    </div>

                    <div class="editor-card">
                        <h3>Contrôles</h3>
                        <div class="editor-kv">
                            <div class="k">Lecture</div><div>Frame fixe (édition)</div>
                            <div class="k">Astuce</div><div>Glissez un point pour le déplacer. Maintenez <b>Shift</b> et cliquez près d’une arête pour ajouter un point.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="editor-bottombar">
                <button class="btn btn-secondary" id="editorCloseBtn2" title="Fermer l’éditeur">Fermer</button>
            </div>
        </div>
    </div>

    <!-- App Modal (internal alerts/confirm) -->
    <div class="editor-overlay hidden" id="appModalOverlay" role="dialog" aria-modal="true" aria-label="Message">
        <div class="editor" style="width:min(520px, 100%); height:auto;">
            <div class="editor-topbar">
                <div>
                    <div class="editor-title" id="appModalTitle">Message</div>
                    <div class="editor-subtitle" id="appModalSubtitle">Zone Tracker</div>
                            </div>
                <button class="btn btn-ghost btn-icon" id="appModalCloseBtn" title="Fermer">✕</button>
                        </div>
            <div style="padding: 16px; background: #1B1E27; color:#F5F7FF; border-top:1px solid rgba(255,255,255,0.08);">
                <div id="appModalMessage" style="white-space: pre-wrap; color: rgba(245,247,255,0.85); line-height:1.5;"></div>
                        </div>
            <div class="editor-bottombar">
                <button class="tool-btn" id="appModalCancelBtn">Annuler</button>
                <button class="tool-btn primary" id="appModalOkBtn">OK</button>
                        </div>
                    </div>
                        </div>

    <script src="/static/js/index.js?v=1" defer></script>
</body>
</html>
