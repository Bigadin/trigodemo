<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YRYS - Zone Presence Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/index.css?v=1">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <svg class="logo" viewBox="0 0 1609.48 1543.54" xmlns="http://www.w3.org/2000/svg">
                    <polygon fill="#0b58d8" points="1609.48 1410.4 708.85 1543.42 856.3 1002.13 1148.84 958.84 1148.96 958.87 1609.48 1410.4"/>
                    <polygon fill="#10b0f9" points="856.3 1002.13 708.81 1543.54 708.69 1543.51 0 971.95 625.87 816.5 625.99 816.53 856.18 1002.1 856.3 1002.13"/>
                    <polygon fill="#f93b09" points="1440.85 915.14 998.21 481.22 1129.3 0 1440.85 915.14"/>
                    <polygon fill="#bd44d5" points="1609.48 1410.4 1148.96 958.87 1441.08 915.72 1609.48 1410.4"/>
                    <polygon fill="#fc5607" points="1129.3 0 998.21 481.22 998.12 481.07 396.67 630.56 1129.3 0"/>
                    <polygon fill="#e7ab37" points="625.87 816.5 0 971.95 396.03 631.03 625.87 816.5"/>
                    <polygon fill="#f8d239" points="998.21 481.22 927.27 741.62 625.99 816.53 625.87 816.5 396.03 631.03 396.67 630.56 998.12 481.07 998.21 481.22"/>
                    <polygon fill="#f08321" points="1441.08 915.72 1148.96 958.87 1148.84 958.84 927.27 741.62 998.21 481.22 1440.85 915.14 1441.08 915.72"/>
                    <polygon fill="#062db6" points="1148.84 958.84 856.3 1002.13 927.27 741.62 1148.84 958.84"/>
                    <polygon fill="#7475d8" points="927.27 741.62 856.3 1002.13 856.18 1002.1 625.99 816.53 927.27 741.62"/>
                </svg>
                <span class="logo-text">YRYS</span>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">General</div>
                <nav class="sidebar-nav">
                    <a class="nav-item active" id="navSites">
                        <img class="nav-icon-img" src="/static/assets_youn/SvIcons/folder-svgrepo-com.svg" alt="">
                        Sites
                    </a>
                    <a class="nav-item" id="navTracker">
                        <img class="nav-icon-img" src="/static/assets_youn/SvIcons/desktop-svgrepo-com.svg" alt="">
                        Zone Tracker
                    </a>
                    <a class="nav-item" href="/static/observations.html" target="_blank" rel="noopener">
                        <img class="nav-icon-img" src="/static/assets_youn/SvIcons/bug-svgrepo-com.svg" alt="">
                        Observations
                    </a>
                </nav>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Active Zones</div>
                <div class="zone-list-sidebar" id="zoneListSidebar">
                    <div style="color: var(--color-text-subtle); font-size: var(--text-sm);">Aucune zone</div>
                </div>
            </div>

            <div class="sidebar-footer">
                <div class="version-badge">©2025 YRYS, Inc — v1.0</div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header-bar">
                <div>
                    <h1 class="page-title" id="pageTitle">Zone Presence Tracker</h1>
                    <p class="page-subtitle" id="pageSubtitle">Surveillance et analyse du temps de présence</p>
                </div>
                <div class="header-actions">
                    <div class="steps">
                        <div class="step" id="step1" title="Caméra">
                            <img class="step-icon-img" src="/static/assets_youn/SvIcons/video-camera-svgrepo-com.svg" alt="">
                            <span class="step-num">1</span>
                        </div>
                        <div class="step" id="step2" title="Zones">
                            <img class="step-icon-img" src="/static/assets_youn/SvIcons/includezone.svg" alt="">
                            <span class="step-num">2</span>
                        </div>
                        <div class="step" id="step3" title="Détection">
                            <img class="step-icon-img" src="/static/assets_youn/SvIcons/checkmark-svgrepo-com.svg" alt="">
                            <span class="step-num">3</span>
                        </div>
                    </div>
                    <div class="status-indicator ready" id="statusBadge">
                        <span class="status-dot-indicator"></span>
                        <span id="statusText">Prêt</span>
                    </div>
                </div>
            </header>

            <!-- Home (Sites) -->
            <section class="zones-section" id="homeView">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-subtitle">Multi-site</div>
                            <div class="card-title">Sites</div>
                        </div>
                    </div>
                    <div style="padding: var(--space-4); border-top: 1px solid var(--color-border); display:flex; gap: var(--space-3); align-items:center; flex-wrap:wrap;">
                        <input id="newSiteName" type="text" placeholder="Nom du site (ex: Entrepôt Lyon)" style="flex:1; min-width: 260px; padding: 12px 14px; border-radius: var(--radius-md); border: 1px solid var(--color-border); background: var(--color-surface-2); color: var(--color-text); outline: none;">
                        <button class="btn btn-primary" id="createSiteBtn" type="button">Créer le site</button>
                    </div>
                    <div style="padding: var(--space-4);">
                        <div class="zones-grid" id="sitesGrid" style="grid-template-columns: repeat(3, minmax(0, 1fr));">
                            <div class="no-zones">Aucun site. Créez-en un pour commencer.</div>
                        </div>
                    </div>
                </div>
            </section>

            <div id="trackerView" class="hidden">
            <!-- Video Section -->
            <section class="video-section">
                <div class="video-card">
                    <div class="video-card-header">
                        <div class="video-title">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                            <span id="currentVideoTitle">Sélectionner une vidéo</span>
                        </div>
                        <div class="active-streams" id="activeStreams"></div>
                    </div>

                    <div class="video-wrapper" id="videoWrapper">
                        <div class="draw-hud hidden" id="drawHud">
                            <div class="draw-hud-left">
                                <div class="draw-hud-title" id="drawHudTitle">Mode dessin</div>
                                <div class="draw-instructions visible" id="drawInstructions">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Cliquez pour placer les points
                                </div>
                            </div>
                            <div class="draw-hud-actions">
                                <button class="btn btn-secondary btn-small" id="undoBtn">Annuler pt</button>
                                <button class="btn btn-primary btn-small" id="finishBtn" disabled>Enregistrer dessin</button>
                                <button class="btn btn-danger btn-small" id="cancelBtn">Annuler</button>
                            </div>
                        </div>
                        <div class="video-placeholder" id="placeholder">
                            <div class="video-placeholder-icon">
                                <img src="/static/assets_youn/SvIcons/video-camera-svgrepo-com.svg" alt="" style="width:44px;height:44px;opacity:0.55;">
                            </div>
                            <div>Sélectionnez une vidéo pour commencer</div>
                        </div>
                        <div class="video-container" id="videoContainer">
                            <img id="videoFrame" class="hidden" alt="Video frame">
                            <img id="videoStream" class="hidden" alt="Video stream">
                            <canvas id="drawCanvas" class="hidden"></canvas>
                        </div>

                        <!-- Dessin: bouton overlay (bas-droite) -->
                        <button class="video-fab" id="drawFab" title="Dessin" type="button">
                            <img src="/static/assets_youn/SvIcons/draw.svg" alt="">
                        </button>
                    </div>

                    <div class="video-toolbar">
                        <!-- Source vidéo: gérée via la liste des caméras (masqué pour garder le mécanisme interne) -->
                        <div class="hidden">
                            <select id="videoSelect">
                                <option value="">-- Choisir une vidéo --</option>
                            </select>
                            <input type="file" id="videoUpload" accept="video/*">
                        </div>

                        <div class="form-row">
                            <button class="btn btn-secondary hidden" id="toggleDrawPanelBtn">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                                Dessin
                            </button>
                            <div class="draw-panel hidden" id="drawPanel">
                                <div class="form-group">
                                    <label class="form-label">Zone</label>
                                    <select id="drawZoneSelect">
                                        <option value="">— Choisir —</option>
                                        <option value="__new__">+ Nouvelle zone…</option>
                                    </select>
                                </div>
                                <div class="form-group hidden" id="drawZoneNameGroup">
                                    <label class="form-label">Nom de zone</label>
                                    <input type="text" id="drawZoneName" placeholder="Ex: Zone A">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Outil</label>
                                    <div class="segmented">
                                        <button class="btn btn-secondary btn-small active" id="toolPolyBtn" type="button">Polygone</button>
                                        <button class="btn btn-secondary btn-small" id="toolLineBtn" type="button">Ligne</button>
                                    </div>
                                </div>
                                <button class="btn btn-primary" id="startDrawBtn" type="button">Tracer</button>
                                <button class="btn btn-secondary" id="stopDrawBtn" type="button">Terminer</button>
                                <div style="width: 1px; height: 28px; background: var(--color-border);"></div>
                                <button class="btn btn-secondary btn-small" id="editSelectedBtn" type="button">Éditer</button>
                                <button class="btn btn-secondary btn-small" id="addPointBtn" type="button">+ Point</button>
                                <button class="btn btn-secondary btn-small" id="deletePointBtn" type="button">- Point</button>
                                <button class="btn btn-primary btn-small" id="saveEditBtn" type="button">Sauver</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Camera/Control Panel -->
                <div class="camera-panel">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-subtitle">Contrôles</div>
                                <div class="card-title">Actions</div>
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column; gap: var(--space-3);">
                            <button class="retro-btn retro-default retro-full" id="startDetectionBtn" disabled>
                                <span class="retro-btn-inner">
                                    <img class="retro-icon-img" src="/static/assets_youn/SvIcons/play-svgrepo-com.svg" alt="">
                                Lancer la détection
                                </span>
                            </button>

                            <!-- (Legacy) conservé hidden pour compat éventuelle -->
                            <button class="btn btn-danger hidden" id="stopDetectionBtn" style="width: 100%;">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"/>
                                </svg>
                                Pause
                            </button>

                            <button class="retro-btn retro-darkGray retro-full" id="stopAllBtn" disabled>
                                <span class="retro-btn-inner">
                                    <img class="retro-icon-img" src="/static/assets_youn/SvIcons/stop-svgrepo-com.svg" alt="">
                                    Stop all
                                </span>
                            </button>

                            <button class="retro-btn retro-light retro-full" id="toggleBlurBtn">
                                <span class="retro-btn-inner">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                                </svg>
                                Floutage: OFF
                                </span>
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-subtitle">Vidéos disponibles</div>
                                <div class="card-title">Caméras</div>
                            </div>
                            <button class="btn btn-secondary btn-icon" id="addCameraBtn" title="Ajouter une caméra" type="button">+</button>
                        </div>
                        <div class="hidden" id="addCameraForm" style="padding: var(--space-4); border-top: 1px solid var(--color-border); display:flex; flex-direction:column; gap: var(--space-3);">
                            <div style="display:flex; gap: var(--space-3); flex-wrap:wrap;">
                                <div class="form-group" style="flex:1; min-width:200px;">
                                    <label class="form-label">Nom caméra</label>
                                    <input id="newCamName" type="text" placeholder="Ex: Entrepôt" style="width:100%;">
                                </div>
                                <div class="form-group" style="flex:1; min-width:200px;">
                                    <label class="form-label">Vidéo</label>
                                    <select id="newCamVideo" class="lov-select" style="width:100%;"></select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Description (optionnel)</label>
                                <input id="newCamHint" type="text" placeholder="Ex: Déchargement & présence" style="width:100%;">
                            </div>
                            <div style="display:flex; gap: var(--space-3);">
                                <button class="btn btn-primary" id="saveCamBtn" type="button">Ajouter</button>
                                <button class="btn btn-secondary" id="cancelCamBtn" type="button">Annuler</button>
                            </div>
                        </div>
                        <div class="camera-grid" id="cameraGrid">
                            <!-- Cameras will be populated here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Zones Section -->
            <section class="zones-section">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-subtitle">Bénéfices (ROI)</div>
                            <div class="card-title">Zones de détections</div>
                        </div>
                        <button class="btn btn-ghost btn-small" id="deleteAllZonesBtn" title="Reset all">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            Reset all
                        </button>
                    </div>
                    <div class="zones-grid" id="zonesGrid">
                        <div class="no-zones">Aucune zone définie pour cette vidéo</div>
                    </div>
                    <div class="recap-grid" id="recapGrid" style="display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: var(--space-4); padding: var(--space-4); border-top: 1px solid var(--color-border);">
                        <div class="card" style="background: transparent; border: 0; box-shadow: none; padding: 0;">
                            <div class="card-subtitle">Caméras</div>
                            <div class="card-title" id="recapCameras">—</div>
                            <div style="color: var(--color-text-muted); font-size: var(--text-xs);" id="recapCamerasSub">—</div>
                        </div>
                        <div class="card" style="background: transparent; border: 0; box-shadow: none; padding: 0;">
                            <div class="card-subtitle">Zones</div>
                            <div class="card-title" id="recapZones">—</div>
                            <div style="color: var(--color-text-muted); font-size: var(--text-xs);" id="recapZonesSub">—</div>
                        </div>
                        <div class="card" style="background: transparent; border: 0; box-shadow: none; padding: 0;">
                            <div class="card-subtitle">Dessins</div>
                            <div class="card-title" id="recapDrawings">—</div>
                            <div style="color: var(--color-text-muted); font-size: var(--text-xs);" id="recapDrawingsSub">—</div>
                        </div>
                        <div class="card" style="background: transparent; border: 0; box-shadow: none; padding: 0;">
                            <div class="card-subtitle">Présences actives</div>
                            <div class="card-title" id="recapActive">—</div>
                            <div style="color: var(--color-text-muted); font-size: var(--text-xs);" id="recapActiveSub">—</div>
                        </div>
                    </div>
                </div>
            </section>
            </div>
        </main>
    </div>

    <!-- Drawing Editor Modal (paint-like) -->
    <div class="editor-overlay hidden" id="editorOverlay" role="dialog" aria-modal="true" aria-label="Éditeur de zones">
        <div class="editor">
            <div class="editor-topbar">
                <div>
                    <div class="editor-title" id="editorTitle">Video Editing</div>
                    <div class="editor-subtitle" id="editorSubtitle">Outils de dessin</div>
                </div>
                <button class="btn btn-ghost btn-icon" id="editorCloseBtn" title="Fermer">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <div class="editor-body">
                <div class="editor-left">
                    <div class="editor-canvas-wrap">
                        <img id="editorFrame" alt="Frame">
                        <canvas id="editorCanvas"></canvas>
                        <div class="editor-hoverbar hidden" id="editorHoverBar">
                            <button class="editor-hoverbtn danger" id="hoverDeletePointBtn" title="Supprimer le point">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 6l12 12M18 6L6 18"/>
                                </svg>
                            </button>
                            <button class="editor-hoverbtn danger" id="hoverDeleteShapeBtn" title="Supprimer la forme">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="editor-tools">
                        <div class="tool-row">
                            <div class="tool-row-left">
                                <button class="tool-btn icon primary active" id="toolSelectBtn" title="Sélection">
                                    <img class="tool-ico" src="/static/assets_youn/YrysUIPackage/selection.svg" alt="">
                                    <span class="tool-label">Sélect</span>
                                </button>
                                <button class="tool-btn icon" id="toolCountLineBtn" title="Ligne de comptage">
                                    <img class="tool-ico" src="/static/assets_youn/YrysUIPackage/comptage.svg" alt="">
                                    <span class="tool-label">Compter</span>
                                </button>
                                <button class="tool-btn icon green" id="toolIncludeBtn" title="Zone d’inclusion">
                                    <img class="tool-ico" src="/static/assets_youn/YrysUIPackage/drawzone.svg" alt="">
                                    <span class="tool-label">Inclure</span>
                                </button>
                                <button class="tool-btn icon yellow" id="toolExcludeBtn" title="Zone d’exclusion">
                                    <img class="tool-ico" src="/static/assets_youn/SvIcons/intersect-svgrepo-com%20(1).svg" alt="">
                                    <span class="tool-label">Exclure</span>
                                </button>
                                <button class="tool-btn icon compact" id="toolUndoBtn" title="Annuler (Ctrl+Z)">↶</button>
                                <button class="tool-btn icon red compact" id="toolClearBtn" title="Tout effacer">✕</button>
                            </div>
                            <button class="tool-btn save" id="toolSaveBtn" title="Sauvegarder toute la configuration">Sauvegarder</button>
                        </div>

                        <div class="editor-guide" id="editorGuide">
                            1) Choisissez une zone à droite. 2) Dessinez (ligne ou polygone). 3) Ajustez les points. 4) Sauvegardez.
                        </div>
                    </div>
                </div>

                <div class="editor-right">
                    <div class="editor-card">
                        <h3>Informations sur la caméra</h3>
                        <div class="editor-kv">
                            <div class="k">ID</div><div id="editorCamId">—</div>
                            <div class="k">Rés.</div><div id="editorCamRes">—</div>
                            <div class="k">Statut</div><div id="editorCamStatus">—</div>
                            <div class="k">Src.</div><div id="editorCamSource">—</div>
                        </div>
                    </div>

                    <div class="editor-card">
                        <h3>Associated Zones</h3>
                        <div class="editor-zones" id="editorZoneList"></div>
                        <div style="margin-top: 10px; display:flex; gap:8px;">
                            <input type="text" id="editorNewZoneName" placeholder="Nouvelle zone…" style="flex:1; min-width:0; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12); color:#F5F7FF;">
                            <button class="tool-btn primary" id="editorAddZoneBtn">+</button>
                        </div>
                        <div style="margin-top: 10px; display:flex; justify-content:flex-end;">
                            <button class="tool-btn red" id="editorDeleteZoneBtn" title="Supprimer la zone sélectionnée">Supprimer la zone</button>
                        </div>
                    </div>

                    <div class="editor-card">
                        <h3>Contrôles</h3>
                        <div class="editor-kv">
                            <div class="k">Lecture</div><div>Frame fixe (édition)</div>
                            <div class="k">Astuce</div><div>Glissez un point pour le déplacer. Maintenez <b>Shift</b> et cliquez près d’une arête pour ajouter un point.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="editor-bottombar">
                <button class="btn btn-secondary" id="editorCloseBtn2" title="Fermer l’éditeur">Fermer</button>
            </div>
        </div>
    </div>

    <!-- App Modal (internal alerts/confirm) -->
    <div class="editor-overlay hidden" id="appModalOverlay" role="dialog" aria-modal="true" aria-label="Message">
        <div class="editor" style="width:min(520px, 100%); height:auto;">
            <div class="editor-topbar">
                <div>
                    <div class="editor-title" id="appModalTitle">Message</div>
                    <div class="editor-subtitle" id="appModalSubtitle">Zone Tracker</div>
                            </div>
                <button class="btn btn-ghost btn-icon" id="appModalCloseBtn" title="Fermer">✕</button>
                        </div>
            <div style="padding: 16px; background: #1B1E27; color:#F5F7FF; border-top:1px solid rgba(255,255,255,0.08);">
                <div id="appModalMessage" style="white-space: pre-wrap; color: rgba(245,247,255,0.85); line-height:1.5;"></div>
                        </div>
            <div class="editor-bottombar">
                <button class="tool-btn" id="appModalCancelBtn">Annuler</button>
                <button class="tool-btn primary" id="appModalOkBtn">OK</button>
                        </div>
                    </div>
                        </div>

    <script src="/static/js/index.js?v=1" defer></script>
</body>
</html>
